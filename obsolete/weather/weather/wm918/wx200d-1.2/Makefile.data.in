# @(#)$Id: Makefile.data.in,v 1.1 2002/09/23 19:12:51 bogdan Rel $

# Copyright (C) 1998 - 2002 Tim Witham <twitham@quiknet.com>

# (see the files README and COPYING for more details)

# This Makefile summarizes .tab data files to .day, .mon, .html

# WARNING: this file contains a .tab dependency on .bin files.  If you
# have files generated by a wx200d version less than 0.7, then many of
# your .tab files may get regenerated!  TO PREVENT THIS, run fixtime
# from the wx200d source distribution before using this Makefile!

# Some of this, especially the functions, is probably GNU make
# specific.  With VPATH set to the data directory, the html can be
# placed in a separate directory by linking this Makefile to there.
# Then an example cron job might look like:

#  5 0 * * * cd @datadir@/@PACKAGE@ && make > /dev/null
# 25 0 * * * cd @datadir@/@PACKAGE@/html && make html > /dev/null

prefix		= @prefix@
exec_prefix	= @exec_prefix@

# path to the .bin, .tab, .day, .mon data logs:
VPATH := @datadir@/@PACKAGE@

# path to the perl scripts that do the conversions:
wxsum	= @sbindir@/wxsum
wxhtml	= @sbindir@/wxplot2html
wxindex	= @sbindir@/wxindex
rrdu	= @sbindir@/wxrrdupdate
rrdg	= @sbindir@/wxrrdgraph

# the (optional?) RRDtool database filename
rrd	= @PACKAGE@.rrd

# hacks to get list of needed .day, .mon, and .html files
month := $(sort $(shell cd $(VPATH) ; ls -1 *.bin.gz *.tab.gz | cut -b 1-6))
mons :=	$(addsuffix .mon,$(month))
html :=	$(addsuffix .html,$(month))
days :=	$(foreach file,$(wildcard *.tab.gz),$(subst .tab.gz,.day,$(file)))
tabs :=	$(foreach file,$(wildcard *.bin.gz),$(subst .bin.gz,.tab.gz,$(file)))
tab :=	$(wildcard *.tab)

all:	$(days)
	$(MAKE) mons

tabs:	$(tabs)
days:	$(days)
mons:	$(mons)
html:	$(html)

.PHONY:	clean

# the foreach returns the month that the day affects
%.day:	%.tab.gz
	zcat $< | $(wxsum) > $@ \
	&& touch $(foreach mon,$(month),$(findstring $(mon),$*))

%.mon:	%
	$(wxsum) $(filter $*%,$(days)) > $@

%.html:	%.mon
	$(wxhtml) --month $* \
	&& $(wxindex) > wx200.html

# WARNING: run fixtime from the source distribution first!
%.tab.gz:	%.bin.gz
	zcat $< | wxfilter | gzip > $@

%.rrd:	$(tab)
	$(rrdu) $@ *.tab*

%.png:	$(rrd)
	$(rrdg) $<
